---

- name: Ansible Lightspeed with IBM watsonx Code Assistant
  hosts: localhost
  vars: 
    base_url: https://c.ai.ansible.redhat.com/
  tasks:

  # https://github.com/ansible/ansible-ai-connect-service/blob/main/tools/openapi-schema/ansible-ai-connect-service.yaml
  # https://github.com/ansible/ansible-ai-connect-service/blob/main/README.md
  # https://access.redhat.com/articles/3626371#busing-apis-for-red-hat-servicesb-1
  - name: Authenticate RH SSO
    ansible.builtin.uri:
      url: "https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token"
      method: POST
      return_content: yes
      status_code: 200
      validate_certs: no
      body_format: form-urlencoded
      body:
        grant_type: "refresh_token"
        client_id: "rhsm-api"
        refresh_token: "{{offline_token }}"
    register: token

  - name: set fact
    set_fact: 
      token_content: "{{ token.content }}"
      access_token: "{{ token.content.access_token }}"

  - name: Debug token
    debug:
      var: token

  - name: Debug token content
    debug:
      var: token.content

  - name: Debug access_token
    debug:
      var: access_token


